# CLARITY Deploy Pipeline
# M10.5: Demo deployment to Netlify (frontend) and Render (backend)
# Separate from CI to maintain CI purity
# SHA-pinned actions for reproducibility

name: Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Explicit permissions - minimal scope
permissions:
  contents: read
  pull-requests: read

# Cancel in-progress deploys for the same branch
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  # Node version for frontend builds
  NODE_VERSION: "20"

jobs:
  # Check if CI passed before deploying
  check-ci:
    name: Check CI Status
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Check CI workflow status
        id: check
        run: |
          # For push events, we assume CI has passed (deploy triggers after CI)
          # For PR events, check if required checks passed
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            # PR events - deploy preview if CI passed
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          fi

  # Check if deploy secrets are configured
  check-secrets:
    name: Check Deploy Secrets
    runs-on: ubuntu-latest
    outputs:
      netlify_configured: ${{ steps.check.outputs.netlify_configured }}
      render_configured: ${{ steps.check.outputs.render_configured }}
    steps:
      - name: Check Netlify secrets
        id: check
        run: |
          if [[ -n "${{ secrets.NETLIFY_AUTH_TOKEN }}" ]] && [[ -n "${{ secrets.NETLIFY_SITE_ID }}" ]]; then
            echo "netlify_configured=true" >> $GITHUB_OUTPUT
            echo "âœ… Netlify secrets are configured"
          else
            echo "netlify_configured=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Netlify secrets not configured - deploy will be skipped"
          fi
          
          if [[ -n "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" ]]; then
            echo "render_configured=true" >> $GITHUB_OUTPUT
            echo "âœ… Render deploy hook is configured"
          else
            echo "render_configured=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Render deploy hook not configured - deploy will be skipped"
          fi

  # Build frontend for deployment
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: [check-ci, check-secrets]
    if: needs.check-ci.outputs.should_deploy == 'true'
    
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build for production
        working-directory: frontend
        env:
          # These will be overridden by Netlify env vars in actual deploy
          # But we need placeholder values for build
          VITE_API_BASE_URL: "https://clarity-demo.onrender.com"
          VITE_APP_MODE: "demo"
          VITE_BUILD_SHA: ${{ github.sha }}
        run: npm run build

      - name: Upload build artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4
        with:
          name: frontend-build
          path: frontend/dist/
          retention-days: 1

  # Deploy preview for PRs (Netlify)
  deploy-preview:
    name: Deploy Preview (Netlify)
    runs-on: ubuntu-latest
    needs: [check-secrets, build-frontend]
    if: |
      github.event_name == 'pull_request' && 
      needs.check-secrets.outputs.netlify_configured == 'true'
    
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Download build artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093  # v4
        with:
          name: frontend-build
          path: frontend/dist

      - name: Deploy to Netlify (Preview)
        id: deploy
        uses: nwtgck/actions-netlify@7a92f00dde8c92a5a9e8385ec2919775f7647352  # v3.0
        with:
          publish-dir: frontend/dist
          production-deploy: false
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Preview deploy from PR #${{ github.event.pull_request.number }}"
          enable-pull-request-comment: true
          enable-commit-comment: false
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Output preview URL
        run: |
          echo "## ðŸš€ Preview Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Preview URL: ${{ steps.deploy.outputs.deploy-url }}" >> $GITHUB_STEP_SUMMARY

  # Deploy production on main (Netlify + Render)
  deploy-production:
    name: Deploy Production
    runs-on: ubuntu-latest
    needs: [check-secrets, build-frontend]
    if: |
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Download build artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093  # v4
        with:
          name: frontend-build
          path: frontend/dist

      # Deploy to Netlify (production)
      - name: Deploy to Netlify (Production)
        if: needs.check-secrets.outputs.netlify_configured == 'true'
        id: netlify
        uses: nwtgck/actions-netlify@7a92f00dde8c92a5a9e8385ec2919775f7647352  # v3.0
        with:
          publish-dir: frontend/dist
          production-deploy: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Production deploy from ${{ github.sha }}"
          enable-commit-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Netlify deployment skipped
        if: needs.check-secrets.outputs.netlify_configured != 'true'
        run: |
          echo "## âš ï¸ Netlify Deployment Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Netlify secrets (NETLIFY_AUTH_TOKEN, NETLIFY_SITE_ID) are not configured." >> $GITHUB_STEP_SUMMARY
          echo "To enable deployment, add these secrets to your repository." >> $GITHUB_STEP_SUMMARY

      # Trigger Render deploy
      - name: Trigger Render Deploy
        if: needs.check-secrets.outputs.render_configured == 'true'
        run: |
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"
          echo "Render deploy triggered"

      - name: Render deployment skipped
        if: needs.check-secrets.outputs.render_configured != 'true'
        run: |
          echo "## âš ï¸ Render Deployment Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Render deploy hook (RENDER_DEPLOY_HOOK_URL) is not configured." >> $GITHUB_STEP_SUMMARY
          echo "To enable deployment, add this secret to your repository." >> $GITHUB_STEP_SUMMARY

      - name: Output production URLs
        if: needs.check-secrets.outputs.netlify_configured == 'true'
        run: |
          echo "## ðŸš€ Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Frontend: ${{ steps.netlify.outputs.deploy-url }}" >> $GITHUB_STEP_SUMMARY
          echo "Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # Post-deploy health check
  healthcheck:
    name: Post-Deploy Health Check
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: |
      always() && 
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main'
    
    steps:
      - name: Wait for deployment
        run: sleep 60  # Give Render time to deploy

      - name: Check backend health
        id: backend-health
        continue-on-error: true
        run: |
          # This will fail if RENDER_SERVICE_URL is not set
          # We'll add it as a variable once Render is configured
          BACKEND_URL="${{ vars.RENDER_SERVICE_URL }}"
          if [[ -n "$BACKEND_URL" ]]; then
            response=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL/health" || echo "000")
            if [[ "$response" == "200" ]]; then
              echo "âœ… Backend health check passed" >> $GITHUB_STEP_SUMMARY
              echo "healthy=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ Backend health check failed (HTTP $response)" >> $GITHUB_STEP_SUMMARY
              echo "healthy=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ RENDER_SERVICE_URL not configured - skipping health check" >> $GITHUB_STEP_SUMMARY
            echo "healthy=skip" >> $GITHUB_OUTPUT
          fi

  # Summary job
  deploy-summary:
    name: Deploy Summary
    runs-on: ubuntu-latest
    needs: [check-secrets, build-frontend, deploy-preview, deploy-production, healthcheck]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## Deploy Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build Frontend | ${{ needs.build-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Preview | ${{ needs.deploy-preview.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Production | ${{ needs.deploy-production.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Check | ${{ needs.healthcheck.result }} |" >> $GITHUB_STEP_SUMMARY

